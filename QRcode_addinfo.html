<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ½çé ˜çèˆ‡é€²åº¦æŸ¥è©¢ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary-color: #34495e;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }
        body {
            font-family: -apple-system, "Microsoft JhengHei", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        h2 { margin-bottom: 10px; color: #2c3e50; }
        #reader {
            width: 100%;
            max-width: 500px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .container {
            width: 100%;
            max-width: 500px;
            margin-top: 15px;
        }
        textarea {
            width: 100%; height: 60px; padding: 12px;
            border: 1px solid #ccc; border-radius: 8px;
            font-size: 16px; box-sizing: border-box;
            margin-bottom: 10px; resize: none;
        }
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        button {
            padding: 12px; font-size: 16px; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .btn-scan { background-color: var(--primary-color); color: white; }
        .btn-query { background-color: var(--danger-color); color: white; }
        .btn-progress { background-color: var(--warning-color); color: white; grid-column: span 2; }
        .btn-update { 
            width: 100%; display: none; 
            background-color: var(--success-color); color: white;
            margin-bottom: 15px;
        }
        button:disabled { background-color: #bdc3c7 !important; cursor: not-allowed; opacity: 0.7; }

        #status { margin: 10px 0; font-size: 14px; color: #e67e22; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        th { background: var(--primary-color); color: white; padding: 10px; font-size: 14px; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px; }

        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background-color: white; margin: 5% auto; padding: 20px;
            width: 90%; max-width: 420px; border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 14px; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;
        }
        .address-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <h2>ğŸ æŠ½çæ ¸éŠ·èˆ‡é€²åº¦ç³»çµ±</h2>
    
    <div id="reader"></div>

    <div class="container">
        <textarea id="scannedResult" placeholder="é»æ“Šé‡æ–°æƒææˆ–åœ¨æ­¤æ‰‹å‹•è¼¸å…¥ç·¨è™Ÿ..."></textarea>
        
        <div class="btn-group">
            <button class="btn-scan" onclick="startScanner()">ğŸ”„ å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
            <button class="btn-query" onclick="handleAction('code')">ğŸ” æ‰‹å‹•æŸ¥è©¢</button>
            <button class="btn-progress" onclick="handleAction('progress')">ğŸ“Š æŸ¥çœ‹å…¨é«”é ˜çé€²åº¦</button>
        </div>
        
        <button id="updateConfirmBtn" class="btn-update" onclick="preSubmitCheck()">âœ… ç¢ºèªé ˜ç</button>
        
        <div id="status">æº–å‚™å°±ç·’</div>
        <div id="displayArea"></div>
    </div>

    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--success-color); margin-top:0;">ğŸ“ å¡«å¯«ä¸­çäººè³‡æ–™</h3>
            <div class="form-group">
                <label>çœŸå¯¦å§“å</label>
                <input type="text" id="userName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="form-group">
                <label>æ‰‹æ©Ÿè™Ÿç¢¼</label>
                <input type="tel" id="userPhone" placeholder="ä¾‹å¦‚: 0912345678">
            </div>
            <div class="form-group">
                <label>èº«åˆ†è­‰å­—è™Ÿ</label>
                <input type="text" id="userIdCard" placeholder="ä¾‹å¦‚: A123456789">
            </div>
            <div class="form-group">
                <label>é€šè¨Šåœ°å€</label>
                <div class="address-row">
                    <select id="userCity" onchange="updateDistricts()">
                        <option value="">é¸æ“‡ç¸£å¸‚</option>
                    </select>
                    <select id="userDistrict">
                        <option value="">é¸æ“‡å€åŸŸ</option>
                    </select>
                </div>
                <input type="text" id="userAddress" placeholder="å‰©é¤˜è·¯æ®µã€é–€ç‰Œã€æ¨“å±¤">
            </div>
            <div class="btn-group">
                <button onclick="closeModal()" style="background:#bdc3c7; color:white;">å–æ¶ˆ</button>
                <button id="finalSubmitBtn" onclick="submitRewardData(true)" style="background:var(--success-color); color:white;">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://projectboy-n8n-free.hf.space/webhook/new_bingo';
        // const WEBHOOK_URL = 'https://buck-decent-bobcat.ngrok-free.app/webhook/new_bingo';
        let html5QrCode;
        let currentNote = ""; // ç”¨æ–¼å­˜æ”¾æŸ¥è©¢åˆ°çš„å‚™è¨»

        const cityData = {
            "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"],
            "å°åŒ—å¸‚": ["ä¸­æ­£å€", "è¬è¯å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "ä¿¡ç¾©å€", "å…§æ¹–å€", "å—æ¸¯å€", "å£«æ—å€", "åŒ—æŠ•å€", "æ–‡å±±å€"],
            "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "ä¸‰é‡å€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ–°èŠå€", "æ–°åº—å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰å³½å€", "æ·¡æ°´å€", "æ±æ­¢å€", "ç‘èŠ³å€", "åœŸåŸå€", "è˜†æ´²å€", "äº”è‚¡å€", "æ³°å±±å€", "æ—å£å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "åªæ—å€", "ä¸‰èŠå€", "çŸ³é–€å€", "å…«é‡Œå€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "é‡‘å±±å€", "è¬é‡Œå€", "çƒä¾†å€"],
            "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€", "ä¸­å£¢å€", "å¤§æºªå€", "æ¥Šæ¢…å€", "è˜†ç«¹å€", "å¤§åœ’å€", "é¾œå±±å€", "å…«å¾·å€", "é¾æ½­å€", "å¹³é®å€", "æ–°å±‹å€", "è§€éŸ³å€", "å¾©èˆˆå€"],
            "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
            "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "ç«¹æ±é®", "æ–°åŸ”é®", "é—œè¥¿é®", "æ¹–å£é„‰", "æ–°è±é„‰", "èŠæ—é„‰", "æ©«å±±é„‰", "åŒ—åŸ”é„‰", "å¯¶å±±é„‰", "å³¨çœ‰é„‰", "å°–çŸ³é„‰", "äº”å³°é„‰"],
            "è‹—æ —ç¸£": ["è‹—æ —å¸‚", "é ­ä»½å¸‚", "ç«¹å—é®", "å¾Œé¾é®", "é€šéœ„é®", "è‹‘è£¡é®", "å“è˜­é®", "é€ æ©‹é„‰", "è¥¿æ¹–é„‰", "é ­å±‹é„‰", "å…¬é¤¨é„‰", "éŠ…é‘¼é„‰", "ä¸‰ç¾©é„‰", "å¤§æ¹–é„‰", "ç…æ½­é„‰", "ä¸‰ç£é„‰", "å—åº„é„‰", "æ³°å®‰é„‰"],
            "å°ä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "å¾Œé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "å’Œå¹³å€", "æ–°ç¤¾å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "å¤§è‚šå€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€"],
            "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚", "å“¡æ—å¸‚", "é¹¿æ¸¯é®", "å’Œç¾é®", "åŒ—æ–—é®", "æºªæ¹–é®", "ç”°ä¸­é®", "äºŒæ—é®", "ç·šè¥¿é„‰", "ä¼¸æ¸¯é„‰", "ç¦èˆˆé„‰", "ç§€æ°´é„‰", "èŠ±å£‡é„‰", "èŠ¬åœ’é„‰", "å¤§æ‘é„‰", "åŸ”é¹½é„‰", "åŸ”å¿ƒé„‰", "æ°¸é–é„‰", "ç¤¾é ­é„‰", "äºŒæ°´é„‰", "ç”°å°¾é„‰", "åŸ¤é ­é„‰", "èŠ³è‹‘é„‰", "å¤§åŸé„‰", "ç«¹å¡˜é„‰", "æºªå·é„‰"],
            "å—æŠ•ç¸£": ["å—æŠ•å¸‚", "åŸ”é‡Œé®", "è‰å±¯é®", "ç«¹å±±é®", "é›†é›†é®", "åé–“é„‰", "é¹¿è°·é„‰", "ä¸­å¯®é„‰", "é­šæ± é„‰", "åœ‹å§“é„‰", "ä¿¡ç¾©é„‰", "ä»æ„›é„‰", "æ°´é‡Œé„‰"],
            "é›²æ—ç¸£": ["æ–—å…­å¸‚", "æ–—å—é®", "è™å°¾é®", "è¥¿èºé®", "åœŸåº«é®", "åŒ—æ¸¯é®", "å¤å‘é„‰", "å¤§åŸ¤é„‰", "è¿æ¡é„‰", "æ—å…§é„‰", "äºŒå´™é„‰", "å´™èƒŒé„‰", "éº¥å¯®é„‰", "æ±å‹¢é„‰", "è¤’å¿ é„‰", "å°è¥¿é„‰", "å…ƒé•·é„‰", "å››æ¹–é„‰", "å£æ¹–é„‰", "æ°´æ—é„‰"],
            "å˜‰ç¾©å¸‚": ["æ±å€", "è¥¿å€"],
            "å˜‰ç¾©ç¸£": ["å¤ªä¿å¸‚", "æœ´å­å¸‚", "å¸ƒè¢‹é®", "å¤§æ—é®", "æ°‘é›„é„‰", "æºªå£é„‰", "æ–°æ¸¯é„‰", "å…­è…³é„‰", "æ±çŸ³é„‰", "ç¾©ç«¹é„‰", "é¹¿è‰é„‰", "æ°´ä¸Šé„‰", "ä¸­åŸ”é„‰", "ç«¹å´é„‰", "æ¢…å±±é„‰", "ç•ªè·¯é„‰", "å¤§åŸ”é„‰", "é˜¿é‡Œå±±é„‰"],
            "å°å—å¸‚": ["ä¸­è¥¿å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å¹³å€", "å®‰å—å€", "æ°¸åº·å€", "æ­¸ä»å€", "æ–°åŒ–å€", "å·¦é®å€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "ä»å¾·å€", "é—œå»Ÿå€", "é¾å´å€", "å®˜ç”°å€", "éº»è±†å€", "ä½³é‡Œå€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "å­¸ç”²å€", "åŒ—é–€å€", "æ–°ç‡Ÿå€", "å¾Œå£å€", "ç™½æ²³å€", "æ±å±±å€", "å…­ç”²å€", "ä¸‹ç‡Ÿå€", "æŸ³ç‡Ÿå€", "é¹½æ°´å€", "å–„åŒ–å€", "å¤§å…§å€", "å±±ä¸Šå€", "æ–°å¸‚å€", "å®‰å®šå€"],
            "é«˜é›„å¸‚": ["æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "é¹½åŸ•å€", "é¼“å±±å€", "æ——æ´¥å€", "å‰é®å€", "ä¸‰æ°‘å€", "æ¥ æ¢“å€", "å°æ¸¯å€", "å·¦ç‡Ÿå€", "ä»æ­¦å€", "å¤§ç¤¾å€", "å²¡å±±å€", "è·¯ç«¹å€", "é˜¿è“®å€", "ç”°å¯®å€", "ç‡•å·¢å€", "æ©‹é ­å€", "æ¢“å®˜å€", "å½Œé™€å€", "æ°¸å®‰å€", "æ¹–å…§å€", "é³³å±±å€", "å¤§å¯®å€", "æ—åœ’å€", "é³¥æ¾å€", "å¤§æ¨¹å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "å…§é–€å€", "æ‰æ—å€", "ç”²ä»™å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€", "èŒ‚æ—å€", "èŒ„è£å€"],
            "å±æ±ç¸£": ["å±æ±å¸‚", "æ½®å·é®", "æ±æ¸¯é®", "æ†æ˜¥é®", "è¬ä¸¹é„‰", "é•·æ²»é„‰", "éºŸæ´›é„‰", "ä¹å¦‚é„‰", "é‡Œæ¸¯é„‰", "é«˜æ¨¹é„‰", "é¹½åŸ”é„‰", "å…§åŸ”é„‰", "ç«¹ç”°é„‰", "å…§åŸ”é„‰", "ç•ªè·¯é„‰", "å¤§åŸ”é„‰", "é˜¿é‡Œå±±é„‰"],
            "å®œè˜­ç¸£": ["å®œè˜­å¸‚", "ç¾…æ±é®", "è˜‡æ¾³é®", "é ­åŸé®", "ç¤æºªé„‰", "å£¯åœé„‰", "å“¡å±±é„‰", "å†¬å±±é„‰", "äº”çµé„‰", "ä¸‰æ˜Ÿé„‰", "å¤§åŒé„‰", "å—æ¾³é„‰"],
            "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚", "é³³æ—é®", "ç‰é‡Œé®", "æ–°åŸé„‰", "å‰å®‰é„‰", "å£½è±é„‰", "å…‰å¾©é„‰", "è±æ¿±é„‰", "ç‘ç©—é„‰", "å¯Œé‡Œé„‰", "ç§€æ—é„‰", "è¬æ¦®é„‰", "å“æºªé„‰"],
            "å°æ±ç¸£": ["å°æ±å¸‚", "æˆåŠŸé®", "é—œå±±é®", "å‘å—é„‰", "é¹¿é‡é„‰", "æ± ä¸Šé„‰", "æ±æ²³é„‰", "é•·æ¿±é„‰", "å¤ªéº»é‡Œé„‰", "å¤§æ­¦é„‰", "ç¶ å³¶é„‰", "æµ·ç«¯é„‰", "å»¶å¹³é„‰", "é‡‘å³°é„‰", "é”ä»é„‰", "è˜­å¶¼é„‰"],
            "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚", "æ¹–è¥¿é„‰", "ç™½æ²™é„‰", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰"],
            "é‡‘é–€ç¸£": ["é‡‘åŸé®", "é‡‘æ¹–é®", "é‡‘æ²™é®", "é‡‘å¯§é„‰", "çƒˆå¶¼é„‰", "çƒåµé„‰"],
            "é€£æ±Ÿç¸£": ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"]
        };

        window.onload = () => {
            const citySelect = document.getElementById('userCity');
            for (let city in cityData) {
                let opt = document.createElement('option');
                opt.value = city;
                opt.innerHTML = city;
                citySelect.appendChild(opt);
            }
        };

        function updateDistricts() {
            const city = document.getElementById('userCity').value;
            const distSelect = document.getElementById('userDistrict');
            distSelect.innerHTML = '<option value="">é¸æ“‡å€åŸŸ</option>';
            if (city && cityData[city]) {
                cityData[city].forEach(dist => {
                    let opt = document.createElement('option');
                    opt.value = dist;
                    opt.innerHTML = dist;
                    distSelect.appendChild(opt);
                });
            }
        }

        function openModal() { document.getElementById('rewardModal').style.display = 'block'; }
        function closeModal() { document.getElementById('rewardModal').style.display = 'none'; }

        function resetRewardForm() {
            document.getElementById('userName').value = "";
            document.getElementById('userPhone').value = "";
            document.getElementById('userIdCard').value = "";
            document.getElementById('userCity').value = "";
            document.getElementById('userDistrict').innerHTML = '<option value="">é¸æ“‡å€åŸŸ</option>';
            document.getElementById('userAddress').value = "";
            document.getElementById('scannedResult').value = "";
            currentNote = ""; // æ¸…é™¤æš«å­˜å‚™è¨»
        }

        async function startScanner() {
            document.getElementById('scannedResult').value = "";
            document.getElementById('displayArea').innerHTML = "";
            document.getElementById('status').innerText = "ç›¸æ©Ÿå•Ÿå‹•ä¸­...";
            document.getElementById('updateConfirmBtn').style.display = 'none';

            if (html5QrCode && html5QrCode.isScanning) {
                try { await html5QrCode.stop(); } catch (e) { }
            }
            html5QrCode = new Html5Qrcode("reader");
            try {
                await html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: 250 },
                    (decodedText) => {
                        document.getElementById('scannedResult').value = decodedText;
                        html5QrCode.stop().then(() => {
                            document.getElementById('status').innerText = "æƒææˆåŠŸï¼Œè‡ªå‹•æŸ¥è©¢ä¸­...";
                            handleAction('code');
                        });
                    }
                );
                document.getElementById('status').innerText = "ç›¸æ©Ÿå·²å°±ç·’";
            } catch (err) { document.getElementById('status').innerText = "ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ"; }
        }

        async function handleAction(actionType) {
            const idValue = document.getElementById('scannedResult').value;
            const displayArea = document.getElementById('displayArea');
            const status = document.getElementById('status');
            const updateBtn = document.getElementById('updateConfirmBtn');
            const allButtons = document.querySelectorAll('button:not(#finalSubmitBtn)');

            if (actionType !== 'progress' && !idValue) {
                alert("è«‹å…ˆè¼¸å…¥æˆ–æƒæç·¨è™Ÿ"); return;
            }

            status.innerText = "é€£ç·šä¸­...";
            allButtons.forEach(btn => { btn.disabled = true; });

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: actionType, id: idValue || "GLOBAL" })
                });
                const content = await response.text();

                if (actionType === 'progress') {
                    displayArea.innerHTML = content;
                    status.innerText = "çµ±è¨ˆæ›´æ–°å®Œæˆ";
                } else if (actionType === 'code') {
                    displayArea.innerHTML = content;
                    status.innerText = "æŸ¥è©¢å®Œæˆ";
                    updateBtn.style.display = 'block';
                    
                    // æš«å­˜å‚™è¨»è³‡è¨Šä¾›å¾ŒçºŒåˆ¤æ–·
                    currentNote = content;

                    if (content.includes("ALREADY_CLAIMED") || content.includes("æ­¤çé …å·²é ˜å–")) {
                        updateBtn.disabled = true; updateBtn.innerText = "ğŸš« å·²é ˜ç";
                    } else if (content.includes("æ­å–œä¸­ç")) {
                        updateBtn.disabled = false; updateBtn.innerText = "âœ… ç¢ºèªé ˜ç";
                    } else {
                        updateBtn.disabled = true; updateBtn.innerText = "âŒ æœªä¸­ç";
                    }
                }
            } catch (error) {
                alert("é€£ç·šå¤±æ•—");
            } finally {
                allButtons.forEach(btn => { if(btn.id !== 'updateConfirmBtn') btn.disabled = false; });
            }
        }

        // --- æ–°å¢ï¼šåˆ¤æ–·æ˜¯å¦éœ€è¦é–‹å•Ÿå½ˆçª— ---
        function preSubmitCheck() {
            // åˆ¤æ–·æŸ¥è©¢å…§å®¹ä¸­æ˜¯å¦åŒ…å« "éœ€èº«åˆ†è­‰"
            if (currentNote.includes("éœ€èº«åˆ†è­‰")) {
                openModal();
            } else {
                // å¦‚æœæ²’æœ‰ï¼Œç›´æ¥å›å‚³çµ¦ n8n (ä¸å¸¶ userInfo)
                if (confirm("æ­¤çé …ä¸éœ€èº«åˆ†è­‰ï¼Œç¢ºèªç«‹å³é ˜çï¼Ÿ")) {
                    submitRewardData(false);
                }
            }
        }

        // ä¿®æ”¹ï¼šå¢åŠ  hasUserInfo åƒæ•¸
        async function submitRewardData(hasUserInfo) {
            const idValue = document.getElementById('scannedResult').value;
            const submitBtn = document.getElementById('finalSubmitBtn');
            const updateBtn = document.getElementById('updateConfirmBtn');
            
            let payload = { 
                action: 'updata', 
                id: idValue 
            };

            if (hasUserInfo) {
                const userData = {
                    name: document.getElementById('userName').value.trim(),
                    phone: document.getElementById('userPhone').value.trim(),
                    idCard: document.getElementById('userIdCard').value.trim(),
                    city: document.getElementById('userCity').value,
                    district: document.getElementById('userDistrict').value,
                    address: document.getElementById('userAddress').value.trim()
                };

                if (!userData.name || !userData.phone || !userData.idCard || !userData.city || !userData.district || !userData.address) {
                    alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼"); return;
                }
                if (!/^09\d{8}$/.test(userData.phone)) {
                    alert("æ‰‹æ©Ÿæ ¼å¼ä¸æ­£ç¢º"); return;
                }
                if (!/^[A-Z][1-2]\d{8}$/.test(userData.idCard)) {
                    alert("èº«åˆ†è­‰æ ¼å¼ä¸æ­£ç¢º"); return;
                }
                payload.userInfo = userData;
            }

            // åœç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
            if(hasUserInfo) {
                submitBtn.disabled = true;
                submitBtn.innerText = "å‚³é€ä¸­...";
            } else {
                updateBtn.disabled = true;
                updateBtn.innerText = "è™•ç†ä¸­...";
            }

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("âœ… é ˜çæ ¸éŠ·æˆåŠŸï¼");
                    resetRewardForm(); 
                    if(hasUserInfo) closeModal();
                    document.getElementById('updateConfirmBtn').style.display = 'none';
                    document.getElementById('status').innerText = "ç‹€æ…‹ï¼šå·²å®Œæˆæ ¸éŠ·";
                    document.getElementById('displayArea').innerHTML = "<h3>âœ… æ ¸éŠ·æˆåŠŸï¼</h3>";
                } else { throw new Error(); }
            } catch (e) {
                alert("å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = "ç¢ºèªé€å‡º";
            }
        }
    </script>
</body>
</html>
