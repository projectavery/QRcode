<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº«å­˜åˆ†æå³æ™‚çœ‹æ¿ (ç©©å®šé€£ç·šç‰ˆ)</title>
    <style>
        :root { --blue: #3182ce; --orange: #ed8936; --red: #e53e3e; --gray: #718096; --bg: #f7fafc; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #2d3748; }
        .container { max-width: 1200px; margin: auto; }
        .header { background: #1a202c; color: white; padding: 25px; border-radius: 15px 15px 0 0; text-align: center; }
        .header h1 { margin: 0; font-size: 28px; letter-spacing: 2px; }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; border-radius: 12px; padding: 25px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .card-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; }
        .chart-img { width: 100%; max-width: 350px; height: auto; display: block; margin: 0 auto; min-height: 200px; }
        .stats { margin-top: 20px; display: flex; justify-content: space-around; background: #fcfcfc; padding: 15px; border-radius: 8px; }
        .stat-value { font-size: 22px; font-weight: bold; }
        .footer { text-align: center; padding: 30px; color: var(--gray); font-size: 14px; line-height: 1.6; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š åº«å­˜åˆ†æå‹•æ…‹çœ‹æ¿</h1>
        <div id="update-time" style="font-size: 14px; opacity: 0.8; margin-top: 10px;">æ­£åœ¨è«‹æ±‚æ•¸æ“š...</div>
    </div>

    <div class="chart-grid">
        <div class="card">
            <div class="card-title" style="color: var(--blue);">é«˜é¡åº«å­˜å æ¯”(é‡‘é¡>500K)</div>
            <img id="chart-high" class="chart-img" src="">
            <div class="stats">
                <div><span style="color:var(--gray)">ç­†æ•¸</span><br><span id="val-high-count" class="stat-value">-</span></div>
                <div><span style="color:var(--gray)">å æ¯”</span><br><span id="val-high-pct" class="stat-value">-</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title" style="color: var(--orange);">ç¼ºæ–™é¢¨éšª (ä½æ–¼æ°´ä½)</div>
            <img id="chart-risk" class="chart-img" src="">
            <div class="stats">
                <div><span style="color:var(--gray)">ç­†æ•¸</span><br><span id="val-risk-count" class="stat-value">-</span></div>
                <div><span style="color:var(--gray)">å æ¯”</span><br><span id="val-risk-pct" class="stat-value">-</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title" style="color: var(--red);">é‡‘é¡ç•°å¸¸ (è² å€¼)</div>
            <img id="chart-error" class="chart-img" src="">
            <div class="stats">
                <div><span style="color:var(--gray)">ç­†æ•¸</span><br><span id="val-error-count" class="stat-value">-</span></div>
                <div><span style="color:var(--gray)">å æ¯”</span><br><span id="val-error-pct" class="stat-value">-</span></div>
            </div>
        </div>
    </div>

    <div class="footer">
        æœ¬å ±è¡¨ç”± n8n Webhook è‡ªå‹•ç”¢ç”Ÿï¼Œæ¯ 3 å°æ™‚åŒæ­¥ä¸€æ¬¡ Google Sheets æ•¸æ“šã€‚<br>
        æœ€å¾Œè¼‰å…¥æˆåŠŸæ™‚é–“ï¼š<span id="last-fetch">-</span>
    </div>
</div>

<script>
    const SHEET_ID = '1IZE-Fgw7IHoyGQjdUpTVg5pFPSklDVIDu9DQZzano3I';
    const GID = '971697619';

    window.handleResponse = function(response) {
        const rows = response.table.rows;
        if (rows && rows.length > 0) {
            const row = rows[0].c;
            const total = row[1]?.v || 0;
            
            // æ›´æ–° UIï¼Œå¸¶å…¥å°æ‡‰çš„åç¨±èˆ‡é¡è‰²ä»£ç¢¼
            updateUI('high', row[2]?.v, row[3]?.v, '%233182ce', 'é«˜é¡åº«å­˜');
            updateUI('risk', row[4]?.v, row[5]?.v, '%23ed8936', 'ä½æ–¼æ°´ä½');
            updateUI('error', row[6]?.v, row[7]?.v, '%23e53e3e', 'é‡‘é¡ç•°å¸¸');

            const now = new Date();
            const timeStr = now.toLocaleString('zh-TW', { 
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
            });

            document.getElementById('update-time').innerText = `çœ‹æ¿åŒæ­¥æ™‚é–“ï¼š${timeStr} (ç¸½è¨ˆ ${total.toLocaleString()} ç­†)`;
            document.getElementById('last-fetch').innerText = timeStr;
        }
    };

    function loadData() {
        const oldScript = document.getElementById('google-data-script');
        if (oldScript) oldScript.remove();
        const script = document.createElement('script');
        script.id = 'google-data-script';
        script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleResponse&gid=${GID}`;
        document.body.appendChild(script);
    }

    function updateUI(type, count, pct, colorCode, labelName) {
        let displayPct = parseFloat(pct);
        if (displayPct < 1 && displayPct > 0) displayPct = (displayPct * 100);
        displayPct = displayPct.toFixed(2);
        let remainPct = (100 - displayPct).toFixed(2);

        document.getElementById(`val-${type}-count`).innerText = Math.floor(count).toLocaleString();
        document.getElementById(`val-${type}-pct`).innerText = displayPct + '%';
        
        // ä½¿ç”¨æ‚¨æä¾›çš„æ–¹å¼ï¼Œç›´æ¥æ‹¼æ¥ URL å­—ä¸²
        // é€™è£¡å°‡ labels:['æ¨™çš„','ç¸½åº«å­˜'] æ›¿æ›ç‚ºå‹•æ…‹å‚³å…¥çš„ labelName
        const chartUrl = "https://quickchart.io/chart?c={type:'doughnut',data:{labels:['" + labelName + "','ç¸½åº«å­˜'],datasets:[{data:[" + displayPct + "," + remainPct + "],backgroundColor:['" + colorCode + "','%23e2e8f0']}]},options:{plugins:{legend:{labels:{font:{size:30}}},doughnutlabel:{labels:[{text:'" + displayPct + "%25',font:{size:40}}]}}}}&w=450&h=450";
        
        document.getElementById(`chart-${type}`).src = chartUrl;
    }

    loadData();
    setInterval(loadData, 10800000);
</script>

</body>
</html>