<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code å…Œçç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f4f4f4; margin: 0; padding: 20px; }
        #preview { width: 100%; max-width: 400px; border: 5px solid #333; border-radius: 10px; margin: 10px auto; display: block; }
        #status { font-size: 1.2rem; margin: 20px; font-weight: bold; }
        .win { color: #d9534f; background: #fff; padding: 20px; border-radius: 10px; border: 2px solid #d9534f; }
        .lose { color: #5bc0de; }
        #loading { color: #888; }
        button { padding: 10px 20px; font-size: 1rem; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>ğŸ æƒæ QR Code å…Œç</h1>
    <div id="loading">æ­£åœ¨è¼‰å…¥ä¸­çåå–®...</div>
    
    <canvas id="preview" hidden></canvas>
    <div id="status">è«‹å…è¨±é–‹å•Ÿç›¸æ©Ÿä»¥é€²è¡Œæƒæ</div>
    
    <div id="result-area"></div>

    <br>
    <button onclick="startScan()">é‡æ–°æƒæ</button>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSkwZLmao8afS8265szRVJHa3s6tFRcS2pEc51_9k92ZS4VmYugFodOfaSYHY8xCSf_5xxwrJf5Epob/pub?gid=31666847&single=true&output=csv';
        let lotteryData = [];
        let video = document.createElement("video");
        let canvasElement = document.getElementById("preview");
        let canvas = canvasElement.getContext("2d");
        let isScanning = false;

        // 1. æŠ“å– Excel (CSV) è³‡æ–™
        function fetchLotteryData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    lotteryData = results.data;
                    document.getElementById('loading').innerText = "âœ… åå–®è¼‰å…¥æˆåŠŸï¼Œè«‹é–‹å§‹æƒæï¼";
                    startScan();
                },
                error: function(err) {
                    document.getElementById('loading').innerText = "âŒ è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£çµã€‚";
                }
            });
        }

        // 2. é–‹å•Ÿæ”å½±æ©Ÿ
        function startScan() {
            document.getElementById('result-area').innerHTML = "";
            document.getElementById('status').innerText = "æƒæä¸­...";
            isScanning = true;
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                requestAnimationFrame(tick);
            });
        }

        // 3. æƒæé‚è¼¯
        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA && isScanning) {
                canvasElement.hidden = false;
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                
                let imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                let code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    isScanning = false;
                    checkPrize(code.data); // è§¸ç™¼æ¯”å°
                }
            }
            if (isScanning) requestAnimationFrame(tick);
        }

        // 4. æ¯”å°å…Œçé‚è¼¯
        function checkPrize(scannedCode) {
            // åœæ­¢æ”å½±æ©Ÿ
            video.srcObject.getTracks().forEach(track => track.stop());
            canvasElement.hidden = true;

            // åœ¨ CSV è³‡æ–™ä¸­å°‹æ‰¾æ¯”å°
            // å‡è¨­ä½ çš„ Excel ç¬¬ä¸€æ¬„æ¨™é¡Œå« "å…Œçç¢¼"ï¼Œç¬¬äºŒæ¬„å« "çé …"
            const winner = lotteryData.find(row => row['å…Œçç¢¼'] === scannedCode.trim());

            const resultArea = document.getElementById('result-area');
            if (winner) {
                resultArea.innerHTML = `
                    <div class="win">
                        <h2>ğŸ‰ æ­å–œä¸­çï¼</h2>
                        <p>æ‚¨çš„ç·¨è™Ÿï¼š${scannedCode}</p>
                        <p>ç²å¾—çé …ï¼š<strong>${winner['çé …'] || 'é»ç'}</strong></p>
                    </div>
                `;
                document.getElementById('status').innerText = "ä¸­çäº†ï¼";
            } else {
                resultArea.innerHTML = `
                    <div class="lose">
                        <h2>ğŸ˜… æ²’ä¸­ç</h2>
                        <p>ç·¨è™Ÿ ${scannedCode} ä¸åœ¨åå–®ä¸­</p>
                    </div>
                `;
                document.getElementById('status').innerText = "ä¸‹æ¬¡æœƒæ›´å¥½ï¼";
            }
        }

        // åˆå§‹åŒ–
        window.onload = fetchLotteryData;
    </script>
</body>
</html>