<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中獎名單自動輪播 (嚴格順序版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            background-color: #1a1a1a;
            color: white;
            font-family: "Microsoft JhengHei", sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #main-container {
            width: 90%;
            max-width: 1200px;
            background: #222;
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #444;
            text-align: center;
            transition: opacity 0.5s ease;
        }
        .header { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 30px; gap: 20px; }
        .prize-tag { background: #e63946; padding: 10px 30px; border-radius: 10px; font-size: 2.5rem; font-weight: bold; min-width: 180px; }
        .prize-name { font-size: 2rem; color: #a8dadc; text-align: left; }
        
        /* 12格排列：4欄 x 3列 */
        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        .ticket-no {
            font-size: 3.5rem;
            font-weight: bold;
            color: #ffb703;
            text-shadow: 0 0 15px rgba(255, 183, 3, 0.6);
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .footer { border-top: 1px solid #444; padding-top: 20px; color: #888; display: flex; justify-content: space-between; font-size: 1.2rem; }
        .hidden { opacity: 0; }
        .loading { font-size: 2rem; color: #ffb703; }
    </style>
</head>
<body>

<div id="main-container">
    <div class="loading">系統連線中，請稍候...</div>
</div>

<script>
    const targetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSkwZLmao8afS8265szRVJHa3s6tFRcS2pEc51_9k92ZS4VmYugFodOfaSYHY8xCSf_5xxwrJf5Epob/pub?gid=31666847&single=true&output=csv';
    const backupProxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(targetUrl);

    // 您的自定義獎項順序
    const PRIZE_ORDER = ["特別獎", "頭獎", "二獎", "三獎", "四獎", "五獎", "六獎", "七獎", "八獎", "九獎", "十獎", "十一獎", "十二獎", "十三獎", "十四獎", "十五獎", "十六獎", "十七獎", "十八獎", "十九獎", "二十獎", "二十一獎", "二十二獎"];

    let groupedData = [];
    let currentIndex = 0;

    async function loadData() {
        try {
            const response = await fetch(targetUrl + '&t=' + new Date().getTime());
            if (!response.ok) throw new Error();
            const text = await response.text();
            processCSV(text);
        } catch (e) {
            const res = await fetch(backupProxy);
            const text = await res.text();
            processCSV(text);
        }
    }

    function processCSV(text) {
        Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                let dict = {};

                results.data.forEach(item => {
                    let rank = (item['獎次'] || '').trim();
                    let content = (item['獎品內容'] || '').trim();
                    if (!rank) return;

                    let key = rank + "|" + content; // 使用組合鍵避免同獎次不同內容被覆蓋
                    if (!dict[key]) {
                        dict[key] = { 
                            rank: rank, 
                            content: content, 
                            remark: item['備註'], 
                            nums: [] 
                        };
                    }
                    if (item['摸彩卷號碼']) dict[key].nums.push(item['摸彩卷號碼'].trim());
                });
                
                // 將字典轉換為陣列並進行自定義排序
                let sortedPrizeKeys = Object.keys(dict).sort((a, b) => {
                    let rankA = dict[a].rank;
                    let rankB = dict[b].rank;
                    let indexA = PRIZE_ORDER.indexOf(rankA);
                    let indexB = PRIZE_ORDER.indexOf(rankB);
                    
                    // 如果不在清單內，排到最後面
                    if (indexA === -1) indexA = 999;
                    if (indexB === -1) indexB = 999;
                    
                    return indexA - indexB;
                });

                let newGroupedData = [];
                sortedPrizeKeys.forEach(key => {
                    let d = dict[key];
                    // 分割成每頁 12 個
                    for (let i = 0; i < d.nums.length; i += 12) {
                        newGroupedData.push({ 
                            rank: d.rank, 
                            content: d.content, 
                            remark: d.remark, 
                            currentNums: d.nums.slice(i, i + 12) 
                        });
                    }
                });

                if (newGroupedData.length > 0) {
                    groupedData = newGroupedData;
                    // 只有初次載入時立即渲染
                    if (document.querySelector('.loading')) {
                        render();
                    }
                }
            }
        });
    }

    function render() {
        const container = document.getElementById('main-container');
        if (groupedData.length === 0) return;
        
        // 檢查索引是否越界（可能因為資料更新變少）
        if (currentIndex >= groupedData.length) currentIndex = 0;

        const data = groupedData[currentIndex];
        container.classList.add('hidden');
        
        setTimeout(() => {
            container.innerHTML = `
                <div class="header">
                    <div class="prize-tag">${data.rank}</div>
                    <div class="prize-name">${data.content}</div>
                </div>
                <div class="numbers-grid">
                    ${data.currentNums.map(n => `<div class="ticket-no">${n}</div>`).join('')}
                </div>
                <div class="footer">
                    <div>備註：${data.remark || '無'}</div>
                    <div>頁次 ${currentIndex + 1} / ${groupedData.length}</div>
                </div>
            `;
            container.classList.remove('hidden');
            currentIndex = (currentIndex + 1) % groupedData.length;
        }, 500);
    }

    loadData();
    setInterval(render, 10000); // 10秒切換一頁
    setInterval(loadData, 60000); // 每分鐘背景更新資料
</script>
</body>
</html>
