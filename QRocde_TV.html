<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幸運中獎名單看板 - 依序撥放版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --warm-red: #8e1b1b;
            --gold-gradient: linear-gradient(135deg, #d4af37 0%, #f9e29c 50%, #b8860b 100%);
            --highlight-gold: #ffeb3b;
            --bg-dark: #1a1616;
            --card-bg: rgba(45, 38, 38, 0.95);
        }

        body {
            font-family: "DFKai-SB", "標楷體", "BiauKai", serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at center, #3d2b2b 0%, #1a1616 100%);
            color: white;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #main-container {
            width: 92%;
            max-width: 1300px;
            min-height: 80vh;
            background: var(--card-bg);
            padding: 40px 50px;
            border-radius: 40px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
            border: 1px solid rgba(212, 175, 55, 0.2);
            text-align: center;
            position: relative;
            transition: opacity 0.6s ease;
        }

        #main-container.hidden { opacity: 0; }

        .phase-tag {
            display: inline-block;
            background: var(--warm-red);
            padding: 8px 35px;
            border-radius: 100px;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(142, 27, 27, 0.4);
        }

        .prize-rank {
            font-size: 4rem;
            font-weight: bold;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 5px 0;
        }

        .prize-content {
            font-size: 2rem;
            color: #e0d0d0;
            margin-bottom: 25px;
            font-weight: bold;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .ticket-no {
            font-size: 2.8rem;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(180deg, #463232 0%, #1e1919 100%);
            padding: 15px 0;
            border-radius: 15px;
            border: 2px solid rgba(212, 175, 55, 0.5);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
        }

        .footer-info {
            display: flex;
            justify-content: space-between;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 20px;
            font-size: 1.2rem;
        }

        .remark-text { color: var(--highlight-gold); font-weight: bold; }
        .loading { font-size: 2rem; color: #d4af37; padding: 100px; }
    </style>
</head>
<body>

<div id="main-container">
    <div class="loading">正在連線至雲端系統...</div>
</div>

<script>
    const targetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSkwZLmao8afS8265szRVJHa3s6tFRcS2pEc51_9k92ZS4VmYugFodOfaSYHY8xCSf_5xxwrJf5Epob/pub?gid=31666847&single=true&output=csv';
    const backupProxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(targetUrl);

    // 定義獎項排序權重
    const PRIZE_ORDER = ["特別獎", "頭獎", "二獎", "三獎", "四獎", "五獎", "六獎", "七獎", "八獎", "九獎", "十獎", "十一獎", "十二獎", "十三獎", "十四獎", "十五獎", "十六獎", "十七獎", "十八獎", "十九獎", "二十獎", "二十一獎", "二十二獎"];

    let groupedData = [];
    let currentIndex = 0;

    async function loadData() {
        try {
            const response = await fetch(targetUrl, { cache: "no-cache" });
            if (!response.ok) throw new Error('直連受阻');
            const csvText = await response.text();
            parseAndProcess(csvText);
        } catch (err) {
            try {
                const proxyRes = await fetch(backupProxy);
                const proxyText = await proxyRes.text();
                parseAndProcess(proxyText);
            } catch (proxyErr) {
                console.error("連線失敗");
            }
        }
    }

    function parseAndProcess(text) {
        Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                processLotteryGroups(results.data);
            }
        });
    }

    function processLotteryGroups(rawData) {
        let dictionary = {};
        rawData.forEach(item => {
            const rank = (item['獎次'] || '').trim();
            const content = (item['獎品內容'] || '').trim();
            if (!rank) return;

            const key = rank + content;
            if (!dictionary[key]) {
                dictionary[key] = {
                    phase: item['抽獎階段'],
                    rank: rank,
                    content: content,
                    remark: item['備註'] || '無',
                    allNumbers: []
                };
            }
            if (item['摸彩卷號碼']) dictionary[key].allNumbers.push(item['摸彩卷號碼']);
        });

        // 依照 PRIZE_ORDER 進行排序
        const sortedKeys = Object.keys(dictionary).sort((a, b) => {
            const indexA = PRIZE_ORDER.indexOf(dictionary[a].rank);
            const indexB = PRIZE_ORDER.indexOf(dictionary[b].rank);
            
            // 如果獎項不在定義名單中，則排在最後面
            const weightA = indexA === -1 ? 999 : indexA;
            const weightB = indexB === -1 ? 999 : indexB;
            
            return weightA - weightB;
        });

        const finalGroups = [];
        sortedKeys.forEach(key => {
            const data = dictionary[key];
            for (let i = 0; i < data.allNumbers.length; i += 15) {
                finalGroups.push({
                    ...data,
                    numbers: data.allNumbers.slice(i, i + 15)
                });
            }
        });

        if (finalGroups.length > 0) {
            // 資料更新時，若原本位置超過新長度，重置回 0
            if (currentIndex >= finalGroups.length) currentIndex = 0;
            groupedData = finalGroups;
            renderDisplay();
        }
    }

    function renderDisplay() {
        if (groupedData.length === 0) return;
        const container = document.getElementById('main-container');
        const group = groupedData[currentIndex];

        container.classList.add('hidden');

        setTimeout(() => {
            const numbersHTML = group.numbers
                .map(num => `<div class="ticket-no">${num}</div>`)
                .join('');

            container.innerHTML = `
                <div class="phase-tag">${group.phase || ''}</div>
                <div class="prize-rank">${group.rank || ''}</div>
                <div class="prize-content">${group.content || ''}</div>
                <div class="numbers-grid">${numbersHTML}</div>
                <div class="footer-info">
                    <span class="remark-text">備註：${group.remark}</span>
                    <span>頁次 ${currentIndex + 1} / ${groupedData.length}</span>
                </div>
            `;
            container.classList.remove('hidden');
            currentIndex = (currentIndex + 1) % groupedData.length;
        }, 600);
    }

    loadData();
    setInterval(renderDisplay, 10000); 
    setInterval(loadData, 60000); 
</script>

</body>
</html>

